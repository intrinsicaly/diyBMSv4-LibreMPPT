<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MPPT Control - diyBMS</title>
<link rel="stylesheet" href="style.css">
<script src="jquery.js"></script>
<script src="pagecode.js"></script>
<script>var XSS_KEY = '%XSS_KEY%';</script>
</head>
<body>
<div id="nav"></div>
<div class="container">
<h1>MPPT CAN Bus Control</h1>

<div id="mppt-settings" class="card">
<h2>Settings</h2>
<form id="mppt-form">
<label>Enable MPPT CAN control: <input type="checkbox" id="mpptEnabled" name="mpptEnabled"></label><br>
<label>Target voltage (V): <input type="number" id="mpptTargetV_display" min="0" max="100" step="0.1"> <input type="hidden" id="mpptTargetV" name="mpptTargetV"></label><br>
<label>Max charge current (A): <input type="number" id="mpptMaxI_display" min="0" max="1000" step="0.1"> <input type="hidden" id="mpptMaxI" name="mpptMaxI"></label><br>
<label>Absorption voltage (V): <input type="number" id="mpptAbsV_display" min="0" max="100" step="0.1"> <input type="hidden" id="mpptAbsV" name="mpptAbsV"></label><br>
<label>Float voltage (V): <input type="number" id="mpptFloatV_display" min="0" max="100" step="0.1"> <input type="hidden" id="mpptFloatV" name="mpptFloatV"></label><br>
<label>Timeout (seconds): <input type="number" id="mpptTimeout" name="mpptTimeout" min="1" max="3600"></label><br>
<label>Timeout action: <select id="mpptTimeoutAction" name="mpptTimeoutAction">
  <option value="0">Stop charging</option>
  <option value="1">Continue</option>
  <option value="2">Local control</option>
</select></label><br>
<label>Mock mode: <input type="checkbox" id="mpptMockMode" name="mpptMockMode"></label><br>
<label>Mock device count: <input type="number" id="mpptMockCount" name="mpptMockCount" min="1" max="4"></label><br>
<button type="button" onclick="saveMPPTSettings()">Save Settings</button>
</form>
</div>

<div id="mppt-devices" class="card">
<h2>MPPT Devices</h2>
<div id="device-list">Loading...</div>
</div>
</div>

<script>
function loadMPPTData() {
  $.getJSON('/api/mppt', function(data) {
    $('#mpptEnabled').prop('checked', data.enabled);
    $('#mpptMockMode').prop('checked', data.mock);
    $('#mpptTargetV_display').val(data.target_voltage);
    $('#mpptTargetV').val(Math.round(data.target_voltage * 10));
    $('#mpptMaxI_display').val(data.max_current);
    $('#mpptMaxI').val(Math.round(data.max_current * 10));
    $('#mpptAbsV_display').val(data.abs_voltage);
    $('#mpptAbsV').val(Math.round(data.abs_voltage * 10));
    $('#mpptFloatV_display').val(data.float_voltage);
    $('#mpptFloatV').val(Math.round(data.float_voltage * 10));
    $('#mpptTimeout').val(data.timeout);
    $('#mpptTimeoutAction').val(data.timeout_action);
    $('#mpptMockCount').val(data.mock_count || 2);

    var html = '';
    if (!data.devices || data.devices.length === 0) {
      html = '<p>No MPPT devices detected.</p>';
    } else {
      data.devices.forEach(function(d) {
        var statusStr = ['Offline','Online','Timeout'][d.status] || 'Unknown';
        html += '<div class="card">';
        html += '<b>MPPT 0x' + d.id.toString(16).toUpperCase() + '</b> - ' + statusStr + '<br>';
        html += 'Solar: ' + d.solar_v.toFixed(1) + 'V / ' + d.solar_i.toFixed(1) + 'A / ' + d.solar_p.toFixed(0) + 'W<br>';
        html += 'Battery: ' + d.bat_v.toFixed(2) + 'V / ' + d.bat_i.toFixed(1) + 'A<br>';
        html += 'Temp: ' + d.temp + '&deg;C | State: ' + d.state + ' | Energy today: ' + d.e_day.toFixed(0) + 'Wh<br>';
        html += 'Charging: ' + (d.charge_en ? 'Yes' : 'No') + ' ';
        html += '<button onclick="controlMPPT(' + d.id + ', ' + !d.charge_en + ')">' + (d.charge_en ? 'Disable' : 'Enable') + ' Charging</button>';
        html += '</div>';
      });
    }
    $('#device-list').html(html);
  }).fail(function() {
    $('#device-list').html('<p>Error loading MPPT data.</p>');
  });
}

function saveMPPTSettings() {
  $('#mpptTargetV').val(Math.round(parseFloat($('#mpptTargetV_display').val()) * 10));
  $('#mpptMaxI').val(Math.round(parseFloat($('#mpptMaxI_display').val()) * 10));
  $('#mpptAbsV').val(Math.round(parseFloat($('#mpptAbsV_display').val()) * 10));
  $('#mpptFloatV').val(Math.round(parseFloat($('#mpptFloatV_display').val()) * 10));

  var enabled = $('#mpptEnabled').is(':checked') ? 'on' : '';
  var mock = $('#mpptMockMode').is(':checked') ? 'on' : '';
  var data = 'xss=' + encodeURIComponent(XSS_KEY) +
    '&mpptEnabled=' + enabled +
    '&mpptMockMode=' + mock +
    '&mpptTargetV=' + $('#mpptTargetV').val() +
    '&mpptMaxI=' + $('#mpptMaxI').val() +
    '&mpptAbsV=' + $('#mpptAbsV').val() +
    '&mpptFloatV=' + $('#mpptFloatV').val() +
    '&mpptTimeout=' + $('#mpptTimeout').val() +
    '&mpptTimeoutAction=' + $('#mpptTimeoutAction').val() +
    '&mpptMockCount=' + $('#mpptMockCount').val();
  $.ajax({url:'/post/savemppt', method:'POST', data:data,
    contentType:'application/x-www-form-urlencoded',
    success:function(){alert('Saved');},
    error:function(){alert('Save failed');}});
}

function controlMPPT(id, enable) {
  var data = 'xss=' + encodeURIComponent(XSS_KEY) + '&id=' + id + '&enable=' + (enable ? 'on' : '');
  $.ajax({url:'/post/mpptcontrol', method:'POST', data:data,
    contentType:'application/x-www-form-urlencoded',
    success:function(){loadMPPTData();},
    error:function(){alert('Control failed');}});
}

$(document).ready(function() {
  loadMPPTData();
  setInterval(loadMPPTData, 5000);
});
</script>
</body>
</html>
